#!/usr/bin/env node
'use strict';

process.env.MICRO_APP_VUEPRESS_DIRECT_RUNNING = true;
const yParser = require('yargs-parser');
const argv = yParser(process.argv.slice(2));
const path = require('path');

const { tryRequire, logger, execa, env } = require('@micro-app/shared-utils');
let MicroAppCLI = tryRequire('@micro-app/cli');
if (!MicroAppCLI) {
    logger.info('[auto]', 'install @micro-app/cli');
    const hasYarn = env.hasYarn();
    const _cmd = hasYarn ? 'yarn' : 'npm';
    const _argv = hasYarn ? [ 'add', '-D' ] : [ 'install', '-D' ];
    const { exitCode, stderr } = execa.sync(_cmd, _argv.concat('@micro-app/cli'), {
        cwd: process.cwd(),
        stdio: 'inherit',
    });
    if (exitCode) {
        logger.throw(stderr);
    }
    const importFresh = require('import-fresh'); // 依赖 @micro-app/shared-utils
    MicroAppCLI = importFresh('@micro-app/cli');
}
if (!MicroAppCLI) {
    logger.throw("Cannot find module '@micro-app/cli'!");
}

const { service } = MicroAppCLI;

[ 'extends', 'commands' ].forEach(name => {
    service.registerPlugin({
        id: `cli:plugin-extend-vuepress-${name}`,
        link: path.resolve(__dirname, `../src/${name}/index.js`),
    });
});

service.run('vuepress', argv);
